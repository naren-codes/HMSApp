@model IEnumerable<HMSApp.Models.Bill>
@{
    Layout = "_Layout";
    ViewData["Title"] = "Payments";
    var doctorName = ViewData["DoctorName"] as string ?? "Doctor";
    var offlineTag = "[OFFLINE PAYMENT]";
}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" />
<link rel="stylesheet" href="~/css/payments.css" asp-append-version="true" />
<div class="payments-wrapper">
  <div class="payments-card">
    <div class="payments-header d-flex flex-wrap justify-content-between align-items-center gap-3">
      <div>
        <h2><i class="bi bi-cash-stack me-2"></i>Payments Received</h2>
        <div class="small opacity-75">Dr. @doctorName – online & offline payments</div>
      </div>
      <div class="search-bar w-100 w-sm-auto">
        <input id="paySearch" type="text" class="form-control form-control-sm" placeholder="Search patient, method or status..." />
      </div>
    </div>
    <div class="table-responsive">
      <table class="table table-hover payments-table mb-0" id="paymentsTable">
        <thead>
          <tr>
            <th>Bill #</th>
            <th>Patient</th>
            <th>Date (UTC)</th>
            <th>Amount (Rs.)</th>
            <th>Method</th>
            <th>Status</th>
            <th>Prescription</th>
          </tr>
        </thead>
        <tbody>
          @foreach (var b in Model.OrderByDescending(x => x.BillDate))
          {
              bool isPaid = b.PaymentStatus == "Paid";
              bool isOffline = isPaid && (b.Prescription?.Contains(offlineTag) ?? false);
              <tr>
                <td>#@b.BillId</td>
                <td>@b.PatientName</td>
                <td>@b.BillDate.ToString("dd MMM yyyy HH:mm")</td>
                <td><strong>@b.TotalAmount.ToString("0.00")</strong></td>
                <td>
                  @if(isOffline){<span class="method-chip cash"><i class="bi bi-wallet2"></i>Offline</span>} else if(isPaid){<span class="method-chip"><i class="bi bi-phone"></i>Online</span>} else {<span class="method-chip"><i class="bi bi-question-circle"></i>—</span>}
                </td>
                <td>
                  @if(isPaid){<span class="status-badge status-paid">Paid</span>} else {<span class="status-badge">Unpaid</span>}
                </td>
                <td class="small">@(!string.IsNullOrWhiteSpace(b.Prescription)? b.Prescription.Substring(0, Math.Min(40,b.Prescription.Length)) + (b.Prescription.Length>40?"...":"") : "-")</td>
              </tr>
          }
          @if(!Model.Any())
          {
            <tr><td colspan="7"><div class="empty-box"><i class="bi bi-info-circle me-1"></i>No bills found.</div></td></tr>
          }
        </tbody>
      </table>
    </div>
  </div>
</div>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script>
$(function(){
  $('#paySearch').on('input', function(){
     var q = $(this).val().toString().toLowerCase();
     $('#paymentsTable tbody tr').each(function(){
        var txt = $(this).text().toLowerCase();
        $(this).toggle(txt.indexOf(q) !== -1);
     });
  });
});
</script>