@* This now points to the ViewModel which holds both appointments and scans *@
@model HMSApp.ViewModels.AppointmentHistoryViewModel

@{
    ViewData["Title"] = "Appointment History";
}

<link rel="stylesheet" href="~/css/appointment-history.css" asp-append-version="true" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />

<div class="ah-wrapper my-5">
    <div class="ah-hero mb-5">
        <h1><i class="bi bi-clock-history"></i> Appointment History</h1>
        <p>Review your past, present, and future appointments. Use the filters to navigate your history.</p>
    </div>

    @if (Model != null && (Model.Appointment.Any() || Model.Scan.Any()))
    {
        <ul class="nav nav-pills ah-filter-pills mb-4">
            <li class="nav-item"><a class="nav-link active" href="#" data-status="all">All</a></li>
            <li class="nav-item"><a class="nav-link" href="#" data-status="upcoming">Upcoming</a></li>
            <li class="nav-item"><a class="nav-link" href="#" data-status="completed">Completed</a></li>
            <li class="nav-item"><a class="nav-link" href="#" data-status="pending">Pending</a></li>
            <li class="nav-item"><a class="nav-link" href="#" data-status="scans">Scans</a></li>
        </ul>

        @* Section 1: APPOINTMENTS - Loops through Model.Appointments *@
        <div id="appointment-list">
            @foreach (var appointment in Model.Appointment)
            {
                <div class="ah-card ah-fade-in" data-status="@appointment.Status.ToLower()">
                    <div class="ah-card-header">
                        <span class="ah-doctor-info">Dr. @appointment.DoctorName</span>
                        <span class="badge bg-secondary">@appointment.Status</span>
                    </div>
                    <div class="ah-details">
                        <div class="ah-detail-item">
                            <i class="bi bi-calendar-event icon"></i>
                            <strong>Date:</strong> @appointment.AppointmentDate.ToString("dd MMMM, yyyy")
                        </div>
                        <div class="ah-detail-item">
                            <i class="bi bi-clock icon"></i>
                            <strong>Time:</strong> @appointment.TimeSlot
                        </div>
                        <div class="ah-detail-item">
                            <i class="bi bi-file-earmark-medical icon"></i>
                            <strong>Symptoms:</strong> @appointment.Symptoms
                        </div>
                    </div>
                </div>
            }
        </div>

        
        <div id="scans-list" style="display:none;">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered align-middle">
                            <thead class="bg-dark text-white">
                                <tr>
                                    <th>Id</th>
                                    <th>Patient Name</th>
                                    <th>Appointment Date</th>
                                    <th>Lab Name</th>
                                    <th>Scan Type</th>
                                    <th>File</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var scan in Model.Scan)
                                {
                                    <tr>
                                        <td>@scan.Id</td>
                                        <td>@scan.PatientName</td>
                                        <td>@scan.AppointmentDate.ToString("dd MMMM, yyyy")</td>
                                        <td>@scan.LabName</td>
                                        <td>@scan.ScanType</td>
                                        <td>
                                            <a asp-action="ViewScanDocument" asp-controller="Patient" asp-route-id="@scan.Id" class="btn btn-info btn-sm" target="_blank">View</a>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="ah-empty-state">
            <i class="bi bi-info-circle icon"></i>
            <h5>No History Found</h5>
            <p>You haven't booked any appointments or scans with us yet.</p>
        </div>
    }
</div>
<div class="text-center mt-5">
    <a asp-action="Dashboard" asp-controller="Patient" class="btn btn-secondary">
        <i class="bi bi-arrow-left-circle"></i> Back to Dashboard
    </a>
</div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script>
        $(document).ready(function () {
            function filterAppointments(status) {
                $('#appointment-list .ah-card').each(function () {
                    var cardStatus = $(this).data('status');
                    if (status === 'all' || cardStatus === status) {
                        $(this).show();
                    } else {
                        $(this).hide();
                    }
                });
            }

            $('.ah-filter-pills .nav-link').on('click', function (e) {
                e.preventDefault();
                $('.ah-filter-pills .nav-link').removeClass('active');
                $(this).addClass('active');
                var status = $(this).data('status');

                if (status === 'scans') {
                    $('#appointment-list').hide();
                    $('#scans-list').show();
                } else {
                    $('#scans-list').hide();
                    $('#appointment-list').show();
                    filterAppointments(status);
                }
            });

            // Set the initial view to the "All" tab
            $('.ah-filter-pills .nav-link[data-status="all"]').trigger('click');
        });
    </script>
}